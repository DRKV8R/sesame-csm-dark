# Dockerfile for Video Generation Service (wan-2.1)
FROM runpod/pytorch:2.2.1-py3.10-cuda12.1.1-devel-ubuntu22.04
WORKDIR /app

# ---- 1. Install System Dependencies ----
RUN apt-get update && apt-get install -y \
    ffmpeg libsm6 libxext6 git \
    && rm -rf /var/lib/apt/lists/* && apt-get clean

# ---- 2. Set Environment Variables ----
ENV VIDEO_MODEL_PATH=Wan-AI/Wan2.1-T2V-1.3B
ENV FFMPEG_BINARY=/usr/bin/ffmpeg
ENV HF_HOME=/workspace/hf_cache

# ---- 3. Install Python Dependencies ----
COPY requirements.txt .
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# ---- 4. Copy Application Code ----
COPY handler.py ./handler.py

# ---- 5. Create Workspace and Set User ----
RUN mkdir -p /workspace/video_loras /workspace/hf_cache && \
    useradd -m -u 1000 -s /bin/bash runpod && \
    chown -R runpod:runpod /app /workspace
USER runpod

# ---- 6. Run the Application Handler ----
CMD ["python", "-u", "handler.py"]
